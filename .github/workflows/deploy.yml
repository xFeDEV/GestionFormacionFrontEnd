# GitHub Actions Workflow para Despliegue AutomÃ¡tico
# Despliega la aplicaciÃ³n React/TypeScript a una VM de Azure con Nginx
name: Deploy to Azure VM

# ConfiguraciÃ³n del activador - se ejecuta en cada push a la rama main
on:
  push:
    branches: [main]
  workflow_dispatch: # Permite ejecuciÃ³n manual desde GitHub UI

# DefiniciÃ³n de trabajos (jobs)
jobs:
  deploy:
    name: Deploy Frontend to Azure VM
    runs-on: ubuntu-latest

    steps:
      # Paso 1: Checkout del cÃ³digo fuente del repositorio
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Obtiene todo el historial para un deploy completo

      # Paso 2: ConfiguraciÃ³n de Node.js para el entorno de CI/CD
      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: "20" # Usar Node.js 20 LTS para compatibilidad Ã³ptima
          cache: "npm" # Cachear dependencias de npm para builds mÃ¡s rÃ¡pidos

      # Paso 3: InstalaciÃ³n de dependencias del proyecto
      - name: Install Dependencies
        run: npm ci # npm ci es mÃ¡s rÃ¡pido y confiable para CI/CD que npm install

      # Paso 4: ConstrucciÃ³n del proyecto React/TypeScript con Vite
      - name: Build React Application
        run: npm run build
        env:
          NODE_ENV: production # Asegurar que se construya para producciÃ³n

      # Paso 5: VerificaciÃ³n de que la carpeta dist/ fue creada correctamente
      - name: Verify Build Output
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Error: La carpeta dist/ no fue generada"
            exit 1
          fi
          echo "âœ… Build completado exitosamente"
          ls -la dist/ # Mostrar contenido de la carpeta dist para debug

      # Paso 6: Despliegue a la VM de Azure vÃ­a SSH
      - name: Deploy to Azure VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          # ConfiguraciÃ³n de conexiÃ³n SSH usando secretos de GitHub
          host: ${{ secrets.VM_IP_PUBLICA }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VM_PORT }}

          # ConfiguraciÃ³n de SSH para mayor seguridad
          command_timeout: 10m # Timeout de 10 minutos para comandos largos

          # Script de despliegue que se ejecutarÃ¡ en la VM
          script: |
            # Mostrar informaciÃ³n del servidor para debug
            echo "ğŸš€ Iniciando despliegue en $(hostname) - $(date)"
            echo "ğŸ“ Usuario actual: $(whoami)"
            echo "ğŸ“‚ Directorio actual: $(pwd)"

            # Paso 6a: Navegar al directorio del repositorio
            echo "ğŸ“ Navegando al directorio del repositorio..."
            cd /home/azureuser/gestionformacionfrontend || {
              echo "âŒ Error: No se pudo acceder al directorio del repositorio"
              exit 1
            }

            # Verificar que estamos en el directorio correcto
            echo "ğŸ“ Directorio actual: $(pwd)"

            # Paso 6b: Obtener los Ãºltimos cambios del repositorio
            echo "ğŸ”„ Actualizando cÃ³digo desde GitHub..."
            git stash push -m "Backup antes del deploy $(date)" || true # Guardar cambios locales si existen
            git pull origin main || {
              echo "âŒ Error: No se pudo actualizar el cÃ³digo desde GitHub"
              exit 1
            }

            # Verificar que el pull fue exitoso
            echo "âœ… CÃ³digo actualizado - Ãºltimo commit:"
            git log -1 --oneline

            # Paso 6c: Instalar/actualizar dependencias de Node.js
            echo "ğŸ“¦ Instalando dependencias de Node.js..."
            npm install || {
              echo "âŒ Error: FallÃ³ la instalaciÃ³n de dependencias"
              exit 1
            }

            # Paso 6d: Construir la aplicaciÃ³n React
            echo "ğŸ”¨ Construyendo aplicaciÃ³n React..."
            npm run build || {
              echo "âŒ Error: FallÃ³ la construcciÃ³n de la aplicaciÃ³n"
              exit 1
            }

            # Verificar que la carpeta dist fue creada
            if [ ! -d "dist" ]; then
              echo "âŒ Error: La carpeta dist/ no fue generada en la VM"
              exit 1
            fi

            echo "âœ… Build completado en la VM"
            echo "ğŸ“Š Contenido de dist/:"
            ls -la dist/

            # Paso 6e: Desplegar archivos al directorio web de Nginx
            echo "ğŸŒ Desplegando archivos a Nginx..."

            # Crear backup del deployment anterior
            BACKUP_DIR="/var/www/backup-$(date +%Y%m%d-%H%M%S)"
            sudo mkdir -p "$BACKUP_DIR" || true
            sudo cp -r /var/www/GestionFormacionFrontend/* "$BACKUP_DIR/" 2>/dev/null || echo "âš ï¸  No hay archivos previos para respaldar"

            # Limpiar directorio web actual
            sudo rm -rf /var/www/GestionFormacionFrontend/*

            # Copiar nuevos archivos construidos
            sudo cp -r dist/* /var/www/GestionFormacionFrontend/ || {
              echo "âŒ Error: No se pudieron copiar los archivos al directorio web"
              # Restaurar backup en caso de error
              sudo cp -r "$BACKUP_DIR"/* /var/www/GestionFormacionFrontend/ 2>/dev/null || true
              exit 1
            }

            # Configurar permisos correctos para Nginx
            sudo chown -R www-data:www-data /var/www/GestionFormacionFrontend/
            sudo chmod -R 755 /var/www/GestionFormacionFrontend/

            # Verificar que los archivos fueron copiados correctamente
            echo "ğŸ“ Archivos desplegados en /var/www/GestionFormacionFrontend/:"
            sudo ls -la /var/www/GestionFormacionFrontend/

            # Reiniciar Nginx para asegurar que los cambios se apliquen
            echo "ğŸ”„ Reiniciando Nginx..."
            sudo systemctl reload nginx || {
              echo "âš ï¸  Advertencia: No se pudo recargar Nginx, intentando restart..."
              sudo systemctl restart nginx || {
                echo "âŒ Error: No se pudo reiniciar Nginx"
                exit 1
              }
            }

            # Verificar estado de Nginx
            if sudo systemctl is-active --quiet nginx; then
              echo "âœ… Nginx estÃ¡ funcionando correctamente"
            else
              echo "âŒ Error: Nginx no estÃ¡ activo"
              sudo systemctl status nginx
              exit 1
            fi

            # Mostrar resumen final del despliegue
            echo ""
            echo "ğŸ‰ Â¡DESPLIEGUE COMPLETADO EXITOSAMENTE!"
            echo "â° Fecha: $(date)"
            echo "ğŸ”— La aplicaciÃ³n estÃ¡ disponible en tu dominio"
            echo "ğŸ“Š Espacio en disco usado:"
            df -h /var/www/
            echo ""
            echo "ğŸ“ Backup guardado en: $BACKUP_DIR"
            echo "ğŸ”§ Para ver logs de Nginx: sudo journalctl -u nginx -f"

      # Paso 7: NotificaciÃ³n de resultado (opcional)
      - name: Deployment Status
        if: always() # Ejecutar siempre, independientemente del resultado anterior
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Despliegue completado exitosamente"
          else
            echo "âŒ Despliegue fallÃ³ - revisar logs arriba"
          fi
